<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Radio Player</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link rel="manifest" href="manifest.json">
	<!-- iOS Web App meta tags -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Radio App">
	<link rel="apple-touch-icon" href="radio-192.png">
	<link rel="icon" type="image/png" href="radio-512.png" />
	<script src="https://kit.fontawesome.com/4dd5a9ae26.js" crossorigin="anonymous"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;1,300&display=swap');
		
		html, body {
			background-color: #ffb8c1;
			font-family: "Public Sans", serif;
			font-optical-sizing: auto;
			font-weight: 300;
			font-style: normal;
		}
		
		#playerContainer {
			width: 250px;
			height: 250px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			border-radius: 10px;
			position: relative;
			margin: 0 auto;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			overflow: hidden;
			background: #fff;
		}

		#stationLogo {
			width: 100%;
			height: 100%;
			object-fit: contain; /* Ensures the full image is visible */
			position: absolute;
			top: 0;
			left: 0;
		}

		#stationName {
			position: absolute;
			top: 10px;
			background: #fff;
			color: #000;
			padding: 5px 10px;
			border-radius: 5px;
			border: 1px solid #000;
			font-size: 1.1rem;
			z-index: 1;
		}

		#clock {
			font-size: 1.5rem;
			font-weight: bold;
			text-align: center;
			margin-bottom: 10px;
		}

		#playPauseButton {
			background: rgba(255, 255, 255, 0.7);
			border: none;
			padding: 10px 20px;
			font-size: 1.2rem;
			cursor: pointer;
			border-radius: 5px;
			z-index: 1;
		}

		#playPauseButton:hover {
			background: rgba(255, 255, 255, 0.9);
		}
	</style>
</head>
<body class="">

<div class="container mt-4 text-center">
	<div class="row justify-content-center">
		<div class="col-8 col-md-3">
		  <h2><img src="radio.jpg" class="img-fluid" alt="Radio Stream Player"></h2>
		</div>
	  </div>

	<div class="row mt-3">
		<!-- Live Clock -->
		<div id="clock"></div>
	</div>

	<div class="row mt-3">
		<!-- Player Container -->
		<div id="playerContainer" class="">
			<img id="stationLogo" src="radio-full-light.png">
			<div id="stationName">Select a station</div>
			<button id="playPauseButton" class="btn"><i class='fa-solid fa-circle-play'></i> Play</button>
			<audio id="audioPlayer" controls style="display: none;"></audio>
		</div>
	</div>

	<div class="row mt-3 justify-content-center">
		<!-- Quick Access Buttons -->
		<h4>Quick Select:</h4>
		<div class="col col-xs-6 col-md-2">
			<button id="play2GB" class="btn btn-dark me-2 quickSelect w-100" data-name="2GB">
				2GB
			</button>
		</div>
		<div class="col col-xs-6 col-md-2">
			<button id="playABCSydney" class="btn btn-dark me-2 quickSelect w-100" data-name="ABC Sydney">
				ABC Sydney
			</button>
		</div>
	</div>
	
	<div class="row mt-3 mb-5">
		<!-- Station Selection -->
		<div class="">
			<h5><label for="stationSelect" class="form-label text-dark">Or select another station:</label></h5>
			<select id="stationSelect" class="form-select">
				<option value="">Loading stations...</option>
			</select>
		</div>
	</div>
	
	<div class="row mt-3 mb-5">
		<!-- Build -->
		<div class="text-gray-200 text-xs">Build 34</div>
		</div>
	</div>
	
</div>

<script>
let audioPlayer = document.getElementById("audioPlayer");
let isPlaying = false;
let loadingTimeout;

$(document).ready(function() {
    $.getJSON("stations.json", function(data) {
        let dropdown = $("#stationSelect");
        dropdown.empty();
        dropdown.append('<option value="">Select a station</option>');

        $.each(data, function(index, station) {
            dropdown.append(`<option value="${station.url}" data-logo="${station.logo}" data-name="${station.name}">${station.name}</option>`);
        });
    });

    // Quick Select button functionality
    $("button.quickSelect").click(function() {
        let stationName = $(this).data("name");

        $("#stationSelect option").each(function() {
            if ($(this).data("name") === stationName) {
                $(this).prop("selected", true).trigger("change");
            }
        });
    });

    // Trigger play automatically when a station is selected via dropdown or quick select
    $("#stationSelect").change(function() {
        let selectedOption = $(this).find(":selected");
        let logo = selectedOption.data("logo");
        let name = selectedOption.data("name");
        let streamUrl = selectedOption.val();

        if (!audioPlayer.paused) {
            audioPlayer.pause();
            isPlaying = false;
            resetPlayButton();
        }

        $("#stationLogo").attr("src", logo || "radio-full-light.png");
        $("#stationName").text(name || "Unknown Station");
        $(document).prop('title', name + ' - Radio Player');

        if (streamUrl) {
            $("#playPauseButton").prop("disabled", false);
            audioPlayer.src = streamUrl;

            // Automatically play the station after selection
            showLoading();
            audioPlayer.play();

            loadingTimeout = setTimeout(function() {
                audioPlayer.pause();
                hideLoading();
                resetPlayButton();
                alert("Failed to load stream. Please try again.");
            }, 10000);
        } else {
            $("#playPauseButton").prop("disabled", true);
        }

        // Update Media Session metadata
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'Radio Player',
                artist: name,
                artwork: [
                    { src: logo, sizes: '512x512', type: 'image/png' }
                ]
            });
        }
    });

    function resetPlayButton() {
        $("#playPauseButton").html("<i class='fa-solid fa-circle-play'></i> Play");
        $("#stationLogo").attr("src", "");
    }

    function showLoading() {
        $("#playPauseButton").html('<i class="fa-solid fa-circle-notch fa-spin"></i>');
    }

    function hideLoading() {
        clearTimeout(loadingTimeout);
    }

    $("#playPauseButton").click(function() {
        if (audioPlayer.src === "") {
            alert("Please select a station first.");
            return;
        }

        if (audioPlayer.paused) {
            showLoading();
            audioPlayer.play();

            loadingTimeout = setTimeout(function() {
                audioPlayer.pause();
                hideLoading();
                resetPlayButton();
                alert("Failed to load stream. Please try again.");
            }, 10000);
        } else {
            audioPlayer.pause();
            hideLoading();
            resetPlayButton();
        }
    });

    audioPlayer.addEventListener("playing", function() {
        hideLoading();
        $("#playPauseButton").html("<i class='fa-solid fa-circle-pause'></i> Pause");
        isPlaying = true;
    });

    audioPlayer.addEventListener("pause", function() {
        hideLoading();
        resetPlayButton();
        isPlaying = false;
    });

    function updateClock() {
        let now = new Date();
        let timeString = now.toLocaleTimeString();
        $("#clock").text(timeString);
    }

    setInterval(updateClock, 1000);
    updateClock();
});

/* 
roll back PWA fix
	if ('mediaSession' in navigator) {
	    navigator.mediaSession.setActionHandler('play', () => {
	        audioPlayer.play();
	    });
	
	    navigator.mediaSession.setActionHandler('pause', () => {
	        audioPlayer.pause();
	    });
	
	    navigator.mediaSession.setActionHandler('stop', () => {
	        audioPlayer.pause();
	        audioPlayer.currentTime = 0;
	    });
	}
	
	document.addEventListener('visibilitychange', () => {
	    if (document.hidden && !audioPlayer.paused) {
	        audioPlayer.pause();
	    }
	});
	
	self.addEventListener('fetch', (event) => {
	    event.respondWith(
	        caches.match(event.request).then((response) => {
	            return response || fetch(event.request);
	        })
	    );
	});
	
	document.getElementById('playButton').addEventListener('click', () => {
	    audioPlayer.play().catch((e) => {
	        console.error('Playback failed:', e);
	    });
	});
*/
</script>


</body>
</html>